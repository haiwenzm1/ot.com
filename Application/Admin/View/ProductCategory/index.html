<extend name="Public/base"/>

<block name="style">
	<link rel="stylesheet" type="text/css" href="__CSS__/myicon.css" media="all">
	<link rel="stylesheet" type="text/css" href="__CSS__/my.css" media="all">
</block>

<block name="body">
	<div class="main-title">
		<h2>分类管理</h2>
	</div>
	<!-- 表格列表 -->
	<div class="tb-unit posr">
		<div class="tb-unit-bar">
			<a class="btn" href="{:U('add')}">新 增</a>
			<span class="myicon r3c16"></span>
		</div>
		<div class="category">
			<div class="hd cf">
				<div class="fold">折叠</div>
				<div class="order">排序</div>
				<div class="name">名称</div>
			</div>
			<div class="item-wrap">
				<form class="cf">
					<div class="fold"><i></i></div>
					<div class="cat-wrap">
						<input type="text" name="title" class="text" value="商品分类" readonly>
					</div>
				</form>
				 
				<div class="item-child">
					{:R('ProductCategory/tree', array($tree))}
				</div>
			</div>
			<div class="cf"></div>
		</div>
	</div>
	<!-- /表格列表 -->
</block>

<block name="script">
	<script type="text/javascript">
		(function($){
			$(function(){
				$('.item-wrap').each(function(){
					if($(this).siblings('.item-wrap').length == 0){
						$(this).find('.item-child').eq(0).css('background','none');
						$(this).children('form').eq(0).find('.fold').css("background-position","22px -55px");
					}else{
						$(this).parent().children('.item-wrap').eq($(this).siblings('.item-wrap').length).find('.item-child').eq(0).css('background','none');
						$(this).parent().children('.item-wrap').eq($(this).siblings('.item-wrap').length).children('form').eq(0).find('.fold').css("background-position","22px -55px");
					}
				})
			})

			/* 分类展开收起 */
			$(".item-child").prev().find(".fold i").addClass("icon-unfold").click(function(){
				var self = $(this);
				
				if(self.hasClass("icon-unfold")){
					self.parent().parent().parent().find(".item-child").eq(0).slideUp("fast", function(){
						self.removeClass("icon-unfold").addClass("icon-fold");
					});
				} else {
					self.parent().parent().parent().find(".item-child").eq(0).slideDown("fast", function(){
						self.removeClass("icon-fold").addClass("icon-unfold");
					});
				}
			});

			/* 实时更新分类信息 */
			$(".category")
				.on("submit", "form", function(){
					var self = $(this);
					$.post(
						self.attr("action"),
						self.serialize(),
						function(data){
							/* 提示信息 */
							var name = data.status ? "success" : "error", msg;
							msg = self.find(".msg").addClass(name).text(data.info)
									  .css("display", "inline-block");
							setTimeout(function(){
								msg.fadeOut(function(){
									msg.text("").removeClass(name);
								});
							}, 1000);
						},
						"json"
					);
					return false;
				})
                .on("focus","input",function(){
                    $(this).data('param',$(this).closest("form").serialize());
                })
                .on("blur", "input", function(){
                    if($(this).data('param')!=$(this).closest("form").serialize()){
                        $(this).closest("form").submit();
                    }
                });
		})(jQuery);
	</script>
</block>
